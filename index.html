<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horas de trabajo</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" href="icon-192.png" type="image/png">
<style>
  body { font-family: sans-serif; margin: 0; padding: 0; }
  h1 { text-align: center; background: #000; color: #fff; padding: 10px; margin: 0; }
  .grid {
    display: grid;
    grid-template-columns: repeat(8, minmax(35px, 1fr));
    border: 1px solid #ccc;
    max-width: 100%;
  }
  .grid div {
    border: 1px solid #ccc;
    height: 40px;
    position: relative;
    cursor: pointer;
  }
  .header { background: #eee; font-weight: bold; text-align: center; font-size: 0.85em; }
  .color-orange { background-color: orange; }
  .color-blue { background-color: lightblue; }
  .color-purple { background-color: #800080; }
  .half-top {
    background: linear-gradient(to top left, transparent 50%, currentColor 50%);
    background-color: transparent;
  }
  .half-bottom {
    background: linear-gradient(to top left, currentColor 50%, transparent 50%);
    background-color: transparent;
  }
  #summary { padding: 10px; background: #f8f8f8; font-size: 0.9em; overflow-x: auto; }
  table { border-collapse: collapse; width: 100%; font-size: 0.85em; }
  th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
  th { background: #eee; }
  .mode-button {
    background: #ddd;
    cursor: pointer;
  }
  .mode-button.active {
    background: #4caf50;
    color: white;
  }
</style>
</head>
<body>
<h1>Horas de trabajo</h1>
<div class="grid" id="grid"></div>
<div id="summary"></div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

const days = ["", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
const startHour = 5;
const endHour = 22;
const colors = ["", "color-orange", "color-blue", "color-purple"];
const grid = document.getElementById("grid");
const summary = document.getElementById("summary");
let data = JSON.parse(localStorage.getItem("workHours") || "{}");
let halfHourMode = false;

function buildGrid() {
  // Celda modo medias horas
  const halfModeCell = document.createElement("div");
  halfModeCell.className = "header mode-button";
  halfModeCell.innerText = "½ h";
  halfModeCell.addEventListener("click", () => {
    halfHourMode = !halfHourMode;
    halfModeCell.classList.toggle("active", halfHourMode);
  });
  grid.appendChild(halfModeCell);

  // Encabezados días
  for (let i = 1; i <= 7; i++) {
    const cell = document.createElement("div");
    cell.className = "header";
    cell.innerText = days[i];
    grid.appendChild(cell);
  }

  // Horas y celdas
  for (let hour = startHour; hour <= endHour; hour++) {
    // Columna hora
    const hourCell = document.createElement("div");
    hourCell.className = "header";
    hourCell.innerText = hour + ":00";
    grid.appendChild(hourCell);

    // Días
    for (let day = 1; day <= 7; day++) {
      const cell = document.createElement("div");
      const key = `${day}-${hour}`;
      if (data[key]) cell.className = data[key];

      // Evento para click/touch
      cell.addEventListener("click", (e) => {
        let rect = cell.getBoundingClientRect();
        let x = e.clientX || (e.touches && e.touches[0].clientX);
        let y = e.clientY || (e.touches && e.touches[0].clientY);
        let offsetX = x - rect.left;
        let offsetY = y - rect.top;

        let currentColor = data[key]?.replace(/ half-(top|bottom)/, "") || "";
        let idx = colors.indexOf(currentColor);
        idx = (idx + 1) % colors.length;

        if (!colors[idx]) {
          delete data[key];
          cell.className = "";
        } else {
          if (halfHourMode) {
            // Determinar si está por encima o debajo de la diagonal
            if (offsetY < rect.height - (offsetX * rect.height / rect.width)) {
              data[key] = colors[idx] + " half-top";
              cell.className = data[key];
            } else {
              data[key] = colors[idx] + " half-bottom";
              cell.className = data[key];
            }
          } else {
            data[key] = colors[idx];
            cell.className = data[key];
          }
        }
        saveData();
        updateSummary();
      });

      grid.appendChild(cell);
    }
  }
}

function saveData() {
  localStorage.setItem("workHours", JSON.stringify(data));
}

function updateSummary() {
  let dailyCounts = {};
  let totals = {orange: 0, blue: 0, purple: 0};
  for (let d = 1; d <= 7; d++) dailyCounts[d] = {orange: 0, blue: 0, purple: 0};

  Object.keys(data).forEach(key => {
    let [day, hour] = key.split("-").map(Number);
    let val = data[key];
    let factor = (val.includes("half-top") || val.includes("half-bottom")) ? 0.5 : 1;
    if (val.includes("orange")) dailyCounts[day].orange += factor;
    if (val.includes("blue")) dailyCounts[day].blue += factor;
    if (val.includes("purple")) dailyCounts[day].purple += factor;
  });

  for (let d = 1; d <= 7; d++) {
    totals.orange += dailyCounts[d].orange;
    totals.blue += dailyCounts[d].blue;
    totals.purple += dailyCounts[d].purple;
  }

  let totalAll = totals.orange + totals.blue + totals.purple;
  let html = `<table>
    <tr>
      <th>Día</th>
      <th>Naranja<br>(Docencia)</th>
      <th>Azul<br>(Investigación)</th>
      <th>Púrpura<br>(Administrativo)</th>
      <th>Total día</th>
    </tr>`;

  const dayNames = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
  for (let d = 1; d <= 7; d++) {
    let dayTotal = dailyCounts[d].orange + dailyCounts[d].blue + dailyCounts[d].purple;
    html += `<tr>
      <td>${dayNames[d-1]}</td>
      <td>${dailyCounts[d].orange}</td>
      <td>${dailyCounts[d].blue}</td>
      <td>${dailyCounts[d].purple}</td>
      <td>${dayTotal}</td>
    </tr>`;
  }

  html += `<tr style="font-weight:bold; background:#eee;">
    <td>Total semana</td>
    <td>${totals.orange}</td>
    <td>${totals.blue}</td>
    <td>${totals.purple}</td>
    <td>${totalAll}</td>
  </tr></table>`;

  summary.innerHTML = html;
}

buildGrid();
updateSummary();
</script>
</body>
</html>